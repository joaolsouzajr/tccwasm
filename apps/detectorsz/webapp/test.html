<!DOCTYPE html>
<html lang="en">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>TCC WASM - Test</title>
  <style type="text/css">
    canvas {
      border: 1px solid black;
    }

    .info {
      background-color: aqua;
    }

    .error {
      background-color: red;
      color: white;
    }
  </style>
</head>

<body>
  <section id="imgproc">
    <div id="message"></div>
    <input id="inputFile" type="file" accept="video/mp4" />
    <label for="scaleResolution">Resolution</label>
    <select name="scaleResolution" id="scaleResolution">
      <option value="0">small (512, 384) - 196,608 px</option>
      <option value="1">medium (768, 480) - 368,640 px</option>
      <option value="2">large (1280, 720) - 921,600 px</option>
    </select>
  </section>
  <section id="secVideo">
    <div style="display:none">
      <video id="videoSrc" width="256" height="240" controls autoplay>
        Your browser does not support the video tag.
      </video>
      <video id="videoSrcSmall" width="512" height="384" controls autoplay>
        Your browser does not support the video tag.
      </video>
      <video id="videoSrcMedium" width="512" height="384" controls autoplay>
        Your browser does not support the video tag.
      </video>
      <video id="videoSrcLarge" width="512" height="384" controls autoplay>
        Your browser does not support the video tag.
      </video>
    </div>
    <canvas id="videoProcessed" width="256" height="240">
    </canvas>
  </section>

  <script type="text/javascript">
    const videoSrc = document.getElementById("videoSrc");
    var streaming = false;
    var frameIndex = 0;
    var vc = null;
    var filter = null;
    var width = 256;
    var height = 240;
    var faceDetect = null;
    var workloadName = "";

    function processVideo() {
      // if(frameIndex > 30) {
      //   stopVideo();
      // }
      let t0 = performance.now();
      let src = vc.read();
      faceDetect.faceDetectWithLog(src);
      Module.showImage('videoProcessed', src);
      src.delete();
      let t1 = performance.now();
      faceDetect.updateTotalTime(frameIndex, t1 - t0);
      frameIndex++;
      requestAnimationFrame(processVideo);
    }

    function stopVideo() {
      if (!streaming) return;
      frameIndex = 0;
      saveLogs();
      stopVideoProcessing();
      document.getElementById("videoProcessed")
        .getContext("2d").clearRect(0, 0, width, height);
      streaming = false;
    }

    function stopVideoProcessing() {
      if (faceDetect != null && !faceDetect.isDeleted()) {
        faceDetect.delete();
      }
    }

    function startVideoProcessing() {
      if (!streaming) {
        console.warn("Please select the video.");
        return;
      }
      stopVideoProcessing();
      faceDetect = new Module.FaceDetect(workloadName);
      requestAnimationFrame(processVideo);
    }

    const showMessage = (message, isError) => {
      var element = document.getElementById('message')
      element.innerHTML = message
      element.className = isError ? 'error' : 'info'
    }

    const playSelectedFile = function (event) {
      let file = this.files[0]
      let type = file.type
      workloadName = file.name.substring(0, file.name.lastIndexOf('.'));
      let videoNode = document.getElementById('videoSrc')
      let canPlay = videoNode.canPlayType(type)
      if (canPlay === '') canPlay = 'no'
      let message = 'Can play type "' + type + '": ' + canPlay
      let isError = canPlay === 'no'
      showMessage(message, isError)
      if (isError) {
        return
      }
      let fileURL = URL.createObjectURL(file)
      videoNode.src = fileURL
    }

    const saveLogs = () => {
      let logData = new Blob(
        [faceDetect.logsToString()], { type: 'application/csv' });
      let elemA = document.createElement('a');
      elemA.style.display = 'none';
      elemA.download = workloadName + ".csv";
      elemA.href = URL.createObjectURL(logData)
      document.body.appendChild(elemA);
      elemA.click();
      document.body.removeChild(elemA);
    }

    const init = () => {
      console.log("TCC WASM - João Lourenço Souza Jr");

      if (streaming) return;

      let inputFile = document.getElementById('inputFile')
      inputFile.addEventListener('change', playSelectedFile, false);

      videoSrc.addEventListener("canplay", function (ev) {
        if (!streaming) {
          streaming = true;
          vc = new Module.VideoCapture(videoSrc);
        }
        startVideoProcessing();
      }, false);

      videoSrc.addEventListener("ended", function (ev) {
        stopVideo();
      }, false);
    };

    var Module = {
      preRun: [],
      postRun: [init],
      print: function (text) {
        if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
        console.log(text);
      },
      printErr: function (text) {
        if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
        console.error(text);
      },
    };
  </script>
  <script async type="text/javascript" src="detectorsz.js"></script>
</body>

</html>
